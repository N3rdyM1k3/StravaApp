using StravaProfisee;
using Azure.Identity;
using Azure.Security.KeyVault.Secrets;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Authentication.OAuth;
using Azure.Core;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.HttpOverrides;

SecretClientOptions options = new SecretClientOptions()
    {
        Retry =
        {
            Delay= TimeSpan.FromSeconds(2),
            MaxDelay = TimeSpan.FromSeconds(16),
            MaxRetries = 5,
            Mode = RetryMode.Exponential
         }
    };
var client = new SecretClient(new Uri("https://profisee-strava-keyvault.vault.azure.net/"), new DefaultAzureCredential(),options);
var builder = WebApplication.CreateBuilder(args);
builder.Services.Configure<ForwardedHeadersOptions>(options =>
        {
            options.ForwardedHeaders =
                ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto;
        });


KeyVaultSecret clientId = client.GetSecret("ClientId");
KeyVaultSecret clientSecret = client.GetSecret("ClientSecret");
var clientIdValue = clientId.Value;
var clientSecretValue = clientId.Value;

// http://localhost:5011/login?ReturnUrl=%2Flogin%3FReturnUrl%3D%252Flogin%253FReturnUrl%253D%25252Flogin%25253FReturnUrl%25253D%2525252Flogin%2525253FReturnUrl%2525253D%252525252Flogin%252525253FReturnUrl%252525253D%25252525252Flogin%25252525253FReturnUrl%25252525253D%2525252525252Flogin%2525252525253FReturnUrl%2525252525253D%252525252525252Flogin%252525252525253FReturnUrl%252525252525253D%25252525252525252Flogin%25252525252525253FReturnUrl%25252525252525253D%2525252525252525252Flogin%2525252525252525253FReturnUrl%2525252525252525253D%252525252525252525252Flogin%252525252525252525253FReturnUrl%252525252525252525253D%25252525252525252525252Flogin%25252525252525252525253FReturnUrl%25252525252525252525253D%2525252525252525252525252Flogin%2525252525252525252525253FReturnUrl%2525252525252525252525253D%252525252525252525252525252Flogin%252525252525252525252525253FReturnUrl%252525252525252525252525253D%25252525252525252525252525252Flogin%25252525252525252525252525253FReturnUrl%25252525252525252525252525253D%2525252525252525252525252525252Flogin%2525252525252525252525252525253FReturnUrl%2525252525252525252525252525253D%252525252525252525252525252525252Flogin%252525252525252525252525252525253FReturnUrl%252525252525252525252525252525253D%25252525252525252525252525252525252Flogin%25252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525253D%2525252525252525252525252525252525252Flogin%2525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525253D%252525252525252525252525252525252525252Flogin%252525252525252525252525252525252525253FReturnUrl%252525252525252525252525252525252525253D%25252525252525252525252525252525252525252Flogin%25252525252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525252525253D%2525252525252525252525252525252525252525252Flogin%2525252525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525252525253D%252525252525252525252525252525252525252525252Flogin%252525252525252525252525252525252525252525253FReturnUrl%252525252525252525252525252525252525252525253D%25252525252525252525252525252525252525252525252Flogin%25252525252525252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525252525252525253D%2525252525252525252525252525252525252525252525252Flogin%2525252525252525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525252525252525253D%252525252525252525252525252525252525252525252525252Flogin%252525252525252525252525252525252525252525252525253FReturnUrl%252525252525252525252525252525252525252525252525253D%25252525252525252525252525252525252525252525252525252Flogin%25252525252525252525252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525252525252525252525253D%2525252525252525252525252525252525252525252525252525252Flogin%2525252525252525252525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525252525252525252525253D%252525252525252525252525252525252525252525252525252525252Flogin%252525252525252525252525252525252525252525252525252525253FReturnUrl%252525252525252525252525252525252525252525252525252525253D%25252525252525252525252525252525252525252525252525252525252Flogin%25252525252525252525252525252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525252525252525252525252525253D%2525252525252525252525252525252525252525252525252525252525252Flogin%2525252525252525252525252525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525252525252525252525252525253D%252525252525252525252525252525252525252525252525252525252525252Flogin%252525252525252525252525252525252525252525252525252525252525253FReturnUrl%252525252525252525252525252525252525252525252525252525252525253D%25252525252525252525252525252525252525252525252525252525252525252Flogin%25252525252525252525252525252525252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525252525252525252525252525252525253D%2525252525252525252525252525252525252525252525252525252525252525252Flogin%2525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525252525252525252525252525252525253D%252525252525252525252525252525252525252525252525252525252525252525252Flogin%252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%252525252525252525252525252525252525252525252525252525252525252525253D%25252525252525252525252525252525252525252525252525252525252525252525252Flogin%25252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525252525252525252525252525252525252525253D%2525252525252525252525252525252525252525252525252525252525252525252525252Flogin%2525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525252525252525252525252525252525252525253D%252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%252525252525252525252525252525252525252525252525252525252525252525252525253D%25252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%25252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525252525252525252525252525252525252525252525253D%2525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%2525252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525252525252525252525252525252525252525252525253D%252525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%252525252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%252525252525252525252525252525252525252525252525252525252525252525252525252525253D%25252525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%25252525252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525252525252525252525252525252525252525252525252525253D%2525252525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%2525252525252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525252525252525252525252525252525252525252525252525253D%252525252525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%252525252525252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%252525252525252525252525252525252525252525252525252525252525252525252525252525252525253D%25252525252525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%25252525252525252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525252525252525252525252525252525252525252525252525252525253D%2525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%2525252525252525252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525252525252525252525252525252525252525252525252525252525253D%252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525253D%25252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%25252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%25252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525253D%2525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin%2525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525253FReturnUrl%2525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525253D%252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252Flogin

// TODO: Handle this better? Idk. 
// var clientIdValue = "1234";
// var clientSecretValue = "1234";

// var stravaClient = new StravaClient();

builder.Services.AddAuthentication(options => {
    options.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = "Strava";
    })
    .AddCookie(o => o.LoginPath = "/signin-strava")
.AddStrava(options =>
{
    options.ClientId = clientIdValue;
    options.ClientSecret = clientSecretValue;
    options.AuthorizationEndpoint = "https://www.strava.com/oauth/authorize";
    options.TokenEndpoint = "https://www.strava.com/api/v3/oauth/token";
});
builder.Services.AddAuthorization();

var app = builder.Build();

app.UseForwardedHeaders();
// app.UseAuthentication();
// app.UseAuthorization();

app.MapGet("/", () => "Hello World"); // .AllowAnonymous();
app.MapGet("/login", () => "Auth").RequireAuthorization();
//app.MapPost("/signin-strava", async (AuthResponse r) => { return Results.Ok(r.access_token);}).AllowAnonymous();
app.Run();
